<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Run toReel.py</title>
    <style>
        #console {
            background-color: black;
            color: #00ff00;
            font-family: monospace;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        
        #cancelBtn, #convertBtn {
            background-color: #ff4444;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        #convertBtn {
            background-color: #44ff44;
        }
        
        #cancelBtn:disabled, #convertBtn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>Video Converter</h1>
    <input type="file" id="inputFile" accept=".mp4,.mov,.avi,.wmv,.flv,.mkv" onchange="handleFileSelect()">
    <button id="convertBtn" onclick="handleConvert()" disabled>Convert</button>
    <button id="cancelBtn" onclick="handleCancel()" disabled>Cancel</button>
    <p id="status"></p>
    <div id="console"></div>

    <script>
        let isConverting = false;
        let currentFileName = '';
        let savedFilePath = null;  // Store the path of the saved file

        function appendToConsole(text) {
            const console = document.getElementById('console');
            console.textContent += text + '\n';
            console.scrollTop = console.scrollHeight;
        }

        function handleCancel() {
            if (isConverting) {
                appendToConsole('Cancelling conversion...');
                document.getElementById('cancelBtn').disabled = true;
                isConverting = false;
            }
        }

        async function handleFileSelect() {
            const fileInput = document.getElementById('inputFile');
            const convertBtn = document.getElementById('convertBtn');
            const statusElement = document.getElementById('status');
            const console = document.getElementById('console');

            if (!fileInput.files.length) {
                statusElement.textContent = 'Please select a video file';
                convertBtn.disabled = true;
                return;
            }

            const file = fileInput.files[0];
            const extension = file.name.split('.').pop().toLowerCase();
            
            console.textContent = '';
            statusElement.textContent = `Selected: ${file.name}`;
            appendToConsole(`File selected: ${file.name}`);
            appendToConsole(`Size: ${(file.size / (1024 * 1024)).toFixed(2)} MB`);
            appendToConsole(`Format: ${extension}`);

            // First, save the file to disk
            const formData = new FormData();
            formData.append('file', file);
            
            appendToConsole('Saving file to disk...');
            
            try {
                const response = await fetch('http://localhost:8000/save-file', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (response.ok) {
                    savedFilePath = data.filepath;
                    appendToConsole(`File saved successfully at: ${savedFilePath}`);
                    convertBtn.disabled = false;
                } else {
                    throw new Error(data.error || 'Failed to save file');
                }
            } catch (error) {
                appendToConsole(`Error saving file: ${error.message}`);
                convertBtn.disabled = true;
            }
        }

        async function handleConvert() {
            if (!savedFilePath) {
                appendToConsole('No saved file path available');
                return;
            }

            const statusElement = document.getElementById('status');
            const convertBtn = document.getElementById('convertBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            
            isConverting = true;
            convertBtn.disabled = true;
            cancelBtn.disabled = false;
            
            statusElement.textContent = `Converting: ${currentFileName}`;
            appendToConsole(`\nStarting conversion using file: ${savedFilePath}`);
            appendToConsole('Running toReel.py...');

            try {
                const response = await fetch('http://localhost:8000/run-script', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        input_path: savedFilePath
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    // Show the actual output from toReel.py
                    if (data.stdout) {
                        appendToConsole('\nOutput from toReel.py:');
                        data.stdout.split('\n').forEach(line => {
                            if (line.trim()) appendToConsole(line);
                        });
                    }
                    if (data.stderr) {
                        appendToConsole('\nErrors/Warnings from toReel.py:');
                        data.stderr.split('\n').forEach(line => {
                            if (line.trim()) appendToConsole(line);
                        });
                    }
                    appendToConsole('\nConversion completed successfully!');
                    appendToConsole(`Output saved as: ${data.output}`);
                    statusElement.textContent = 'Conversion completed!';
                } else {
                    throw new Error(data.error || 'Conversion failed');
                }
            } catch (error) {
                appendToConsole(`\nError details:`);
                appendToConsole(error.toString());
                if (error.stdout) appendToConsole(error.stdout);
                if (error.stderr) appendToConsole(error.stderr);
                statusElement.textContent = 'Conversion failed';
            } finally {
                isConverting = false;
                cancelBtn.disabled = true;
                convertBtn.disabled = true;
            }
        }
    </script>
</body>
</html>
